# 5. Template System and Self-Consistent Refinement

The **Template System** is the core interface between raw scientific documents and structured knowledge within the Discovery Engine. It defines how LLMs extract, justify, and encode knowledge artifacts, and evolves dynamically to reflect the structure of the literature itself.

---

## 5.1 Purpose of the Template System

The goal is to **transform unstructured prose into semantically explicit, machine-verifiable knowledge artifacts**, with minimal hallucination and maximal reusability.

### Motivation

| Challenge in Raw Text            | Template Solution                                         |
|----------------------------------|-----------------------------------------------------------|
| Vague or nested claims           | Probed extraction with slot definitions                   |
| Implicit assumptions             | Required justification from source text                  |
| Mixed levels of abstraction      | Segmented modules: concepts, methods, parameters          |
| Semantic drift across papers     | Schema enforcement and alignment                          |
| Missing or inconsistent fields   | Gap detection + template evolution                        |

---

## 5.2 Template Design Structure

Templates are **modular**, field-specific, and written in structured plain text (Markdown, JSON, YAML). Each template acts as an analytical contract that an LLM must satisfy.

### Key Features

| Feature                    | Description                                                           |
|----------------------------|-----------------------------------------------------------------------|
| **Schema-conformance**     | Each field maps to a known node or edge type in the Universal Schema  |
| **Justification Required** | LLM must quote or reference exact source text for each extracted item |
| **Slot Typing**            | Values must conform to expected formats (e.g., number, unit, DOI)      |
| **Scoring Rubrics**        | Prompts LLM to assess e.g. replicability, clarity, constraint          |
| **Meta-probes**            | Ask LLMs whether the template missed anything important                |

### Example: Template Modules (Field: Intelligent Soft Matter)

| Module ID | Title                      | Example Output                             |
|-----------|----------------------------|--------------------------------------------|
| M0        | Metadata                   | DOI, Authors, Year                         |
| M1        | Core Claims                | "Material X adapts to stimulus Y"          |
| M2        | System Description         | "Hydrogel matrix embedded with circuit"    |
| M3        | Mechanism & Function       | "Swelling activates a feedback loop"       |
| M4        | Parameter Specification    | "Swelling time = 3s @ 22°C"                |
| M5        | Results & Observations     | "Adaptive stiffness increased by 40%"      |
| M6        | Limitations & Gaps         | "No dynamic fatigue testing reported"      |

---

## 5.3 Extraction Process with Templates

1. **Scope Definition**: Select field-specific template version  
2. **LLM Prompting**: Load the template into the prompt along with the source paper  
3. **Extraction**: LLM fills out each field with:
   - Canonicalised values
   - Direct textual support
   - Confidence and rubrics  
4. **Validation Layer**:
   - Format-checks
   - Source-reference linkage
   - Schema alignment  
5. **Artifact Registration**:
   - Adds extracted items into CNM
   - Flags inconsistencies
   - Computes initial scores

---

## 5.4 Self-Consistent Refinement Loop

Templates aren’t static — they evolve based on how well they capture the actual structure of a domain.

### Refinement Workflow

```plaintext
[Template v0]
    ↓
[LLM extraction on batch corpus]
    ↓
[Aggregated feedback]
    ↓
[Schema mismatch analysis]
    ↓
[Template v1 with updated slots, examples, or probes]
    ↓
Repeat until convergence
```

### Types of Feedback Signals

| Source                         | Example Insight                                            |
|--------------------------------|------------------------------------------------------------|
| **Missing field patterns**     | "Swelling rate" appears often but isn’t in the template    |
| **LLM self-assessment**        | “Template failed to capture emergent behaviour logic”      |
| **Low artifact alignment**     | Same claim rendered differently across papers              |
| **Redundant fields**           | Multiple fields always contain overlapping values          |
| **Concept drift**              | Term 'intelligence' evolves — needs new slot for criteria  |

Templates adapt toward a **dynamically stabilised schema** reflective of the collective structure of knowledge in that field.

---

## 5.5 Analogies and Inspirations

The refinement loop draws from several well-known patterns:

| Analogy                    | Description                                                    |
|----------------------------|----------------------------------------------------------------|
| **Self-consistent field theory (physics)** | Template converges to reflect the field structure  |
| **Compiler grammars**      | Strict formal structure with typed expectations                |
| **Biological evolution**   | Iterative fitness-improving adaptation to conceptual ecosystem |
| **Meta-learning**          | Template learns how to learn from the corpus                   |

---

## 5.6 Benefits of the Template System

| Benefit                   | Explanation                                                    |
|---------------------------|----------------------------------------------------------------|
| **Consistency**           | Enforces structural regularity across extractions              |
| **Traceability**          | All outputs traceable to source phrases                        |
| **Robustness**            | Reduces hallucination and forces schema conformance            |
| **Adaptability**          | Evolves as fields change or new artefact types emerge          |
| **Domain-specificity**    | Supports unique vocabularies and epistemic norms per field     |

---

## 5.7 Edge Cases and Mitigation

| Risk                          | Safeguard                                                        |
|-------------------------------|------------------------------------------------------------------|
| LLM hallucination             | Justification and reference checks                              |
| Schema misspecification       | Meta-probes and feedback signals from extraction                 |
| Incomplete mapping            | Semi-automated gap detection and refinement                      |
| Overfitting to narrow corpus  | Cross-domain benchmarking and generalisability audits           |

---

## 5.8 Template Lifecycle

Templates go through versioned development:

```plaintext
Template v0: Expert-designed schema
Template v1: Initial LLM feedback
Template v2: Field-specific adjustments
Template v3: Post gap-analysis synthesis
Template vN: Domain-stable consensus schema
```

Each template version is saved, versioned, and associated with a provenance chain.

---

> ☑️ Visual prompt for napkin.ai:
>
> **Title**: “Adaptive Template Refinement Loop”
>
> - Circular loop diagram:
>     - Start: “Template v0”
>     - Then: “LLM Extraction”
>     - Then: “Corpus Feedback”
>     - Then: “Schema Update”
>     - Loop arrow: back to “Template v1”
>
> - Side panels:
>     - Top: “Template Modules” (M0–M6)
>     - Bottom-left: “Field-Specific Slots” (e.g., parameters, mechanisms)
>     - Bottom-right: “Meta-Probes” (“What was missed?”)
>
> - Footer: “Goal: Schema ↔ Corpus Alignment”
